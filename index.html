<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sondage ultra s√©rieux</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .box {
      background: #1e1e1e;
      padding: 30px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 0 20px rgba(255,0,0,0.4);
    }
    h1 { text-align: center; color: #ff3b3b; margin-bottom: 10px; }
    .objective {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      border: 2px solid #ff3b3b;
    }
    .counters {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }
    .counter {
      text-align: center;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 8px;
      flex: 1;
      margin: 0 5px;
    }
    .counter-label {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 5px;
    }
    .counter-value {
      font-size: 32px;
      font-weight: bold;
      color: #ff3b3b;
    }
    button {
      width: 100%;
      padding: 15px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      background: #ff3b3b;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover { 
      background: #ff5c5c;
      transform: scale(1.02);
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    .result { 
      margin-top: 20px;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 8px;
      text-align: center;
    }
    .success {
      background: #1a4d1a;
      border: 2px solid #4caf50;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .voters {
      margin-top: 15px;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    .voters h3 {
      margin-top: 0;
      color: #ff3b3b;
      font-size: 16px;
    }
    .voter-item {
      padding: 5px;
      margin: 5px 0;
      background: #1e1e1e;
      border-radius: 4px;
      font-size: 14px;
    }
    input {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: 2px solid #ff3b3b;
      border-radius: 8px;
      background: #2a2a2a;
      color: white;
      font-size: 16px;
      box-sizing: border-box;
    }
    input::placeholder {
      color: #888;
    }
  </style>
</head>
<body>
  <div class="box">
    <h1>üî• Sondage officiel üî•</h1>
    
    <div class="objective">
      <p style="margin: 0;">üì∏ Objectif : √† <strong>30 OUI</strong></p>
      <p style="margin: 5px 0 0 0;">Alexis poste une <strong>photo honteuse</strong> üòà</p>
    </div>

    <div class="counters">
      <div class="counter">
        <div class="counter-label">üëç OUI</div>
        <div class="counter-value" id="ouiCount">0</div>
      </div>
      <div class="counter">
        <div class="counter-label">üëé NON</div>
        <div class="counter-value" id="nonCount">0</div>
      </div>
    </div>

    <input type="text" id="nameInput" placeholder="Entre ton pr√©nom..." maxlength="30" />
    
    <button id="btnOui">‚úÖ Oui, √©videmment</button>
    <button id="btnNon">‚ùå Non (menteur)</button>
    
    <div class="result" id="result">Chargement de Firebase...</div>
    
    <div class="voters" id="votersSection" style="display: none;">
      <h3>üìã Ont vot√© :</h3>
      <div id="votersList"></div>
    </div>
  </div>

  <!-- Charger Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script>
    // Attendre que Firebase soit charg√©
    window.addEventListener('load', function() {
      console.log('Page charg√©e, initialisation Firebase...');
      
      // V√©rifier que Firebase est disponible
      if (typeof firebase === 'undefined') {
        alert('‚ùå Firebase n\'a pas pu √™tre charg√©. V√©rifie ta connexion internet.');
        return;
      }
      
      console.log('Firebase disponible:', firebase);

      // Configuration Firebase
      var firebaseConfig = {
        apiKey: "AIzaSyDXdzhzD0dIKU-uEn-wUMsLo2rYhbFJozg",
        authDomain: "les-pieds-de-alexis.firebaseapp.com",
        databaseURL: "https://les-pieds-de-alexis-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "les-pieds-de-alexis",
        storageBucket: "les-pieds-de-alexis.appspot.com",
        messagingSenderId: "605697210821",
        appId: "1:605697210821:web:2915887c8fe5e5244833ac"
      };

      // Initialiser Firebase
      firebase.initializeApp(firebaseConfig);
      var database = firebase.database();
      var votesRef = database.ref('votes');
      var votersRef = database.ref('voters');
      
      console.log('‚úÖ Firebase initialis√©');
      document.getElementById('result').innerHTML = 'Pr√™t √† voter !';

      // Fonction pour mettre √† jour l'affichage
      function updateDisplay(data) {
        console.log('Mise √† jour display:', data);
        var votes = data || { oui: 0, non: 0 };
        
        document.getElementById('ouiCount').textContent = votes.oui || 0;
        document.getElementById('nonCount').textContent = votes.non || 0;

        var resultDiv = document.getElementById('result');
        var ouiCount = votes.oui || 0;
        
        if (ouiCount >= 30) {
          resultDiv.className = 'result success';
          resultDiv.innerHTML = 'üéâ <strong>OBJECTIF ATTEINT !</strong> üéâ<br>Alexis doit poster une photo honteuse üòà';
        } else {
          resultDiv.className = 'result';
          var remaining = 30 - ouiCount;
          resultDiv.innerHTML = 'Plus que <strong>' + remaining + '</strong> OUI pour atteindre l\'objectif !';
        }
      }

      // Fonction pour mettre √† jour la liste des votants
      function updateVotersList(voters) {
        var votersList = document.getElementById('votersList');
        var votersSection = document.getElementById('votersSection');
        
        if (!voters || Object.keys(voters).length === 0) {
          votersSection.style.display = 'none';
          return;
        }
        
        votersSection.style.display = 'block';
        var votersArray = Object.values(voters);
        var html = '';
        for (var i = votersArray.length - 1; i >= 0; i--) {
          html += '<div class="voter-item">' + votersArray[i] + '</div>';
        }
        votersList.innerHTML = html;
      }

      // √âcouter les changements en temps r√©el
      votesRef.on('value', function(snapshot) {
        console.log('Votes re√ßus:', snapshot.val());
        updateDisplay(snapshot.val());
      });

      votersRef.on('value', function(snapshot) {
        console.log('Votants re√ßus:', snapshot.val());
        updateVotersList(snapshot.val());
      });

      // Fonction de vote
      function faireVote(choice) {
        console.log('=== D√âBUT VOTE:', choice);
        
        var nameInput = document.getElementById('nameInput');
        var name = nameInput.value.trim();
        
        if (!name) {
          alert('‚ùå Entre ton pr√©nom avant de voter !');
          nameInput.focus();
          return;
        }

        console.log('Pr√©nom:', name);

        // R√©cup√©rer les votants
        votersRef.once('value')
          .then(function(votersSnapshot) {
            console.log('Votants r√©cup√©r√©s');
            var voters = votersSnapshot.val() || {};
            var nameLower = name.toLowerCase();
            
            // Chercher si d√©j√† vot√©
            var alreadyVotedKey = null;
            var oldChoice = null;
            
            for (var key in voters) {
              var voterName = voters[key].split(' ‚Üí ')[0].toLowerCase();
              if (voterName === nameLower) {
                alreadyVotedKey = key;
                oldChoice = voters[key].indexOf('OUI') !== -1 ? 'oui' : 'non';
                break;
              }
            }

            // Si d√©j√† vot√©
            if (alreadyVotedKey) {
              console.log('D√©j√† vot√© d√©tect√©');
              var revote = confirm('‚ö†Ô∏è "' + name + '" a d√©j√† vot√© !\n\nVeux-tu modifier ton vote ?');
              if (!revote) {
                console.log('Revote annul√©');
                return Promise.reject('Annul√©');
              }
              
              // Supprimer l'ancien vote
              console.log('Suppression ancien vote');
              delete voters[alreadyVotedKey];
              
              // D√©cr√©menter ancien compteur
              return votesRef.once('value').then(function(votesSnapshot) {
                var currentVotes = votesSnapshot.val() || { oui: 0, non: 0 };
                if (currentVotes[oldChoice] > 0) {
                  currentVotes[oldChoice]--;
                }
                return votesRef.set(currentVotes).then(function() {
                  return voters;
                });
              });
            } else {
              return Promise.resolve(voters);
            }
          })
          .then(function(voters) {
            console.log('Confirmation du vote');
            var confirmation = confirm('Confirmes-tu ton vote : ' + choice.toUpperCase() + ' ?\n\nPr√©nom : ' + name);
            if (!confirmation) {
              console.log('Vote annul√©');
              return Promise.reject('Annul√©');
            }

            console.log('R√©cup√©ration votes actuels');
            // R√©cup√©rer votes actuels
            return votesRef.once('value').then(function(votesSnapshot) {
              var currentVotes = votesSnapshot.val() || { oui: 0, non: 0 };
              currentVotes[choice] = (currentVotes[choice] || 0) + 1;
              
              console.log('Sauvegarde votes:', currentVotes);
              // Sauvegarder votes
              return votesRef.set(currentVotes).then(function() {
                return voters;
              });
            });
          })
          .then(function(voters) {
            console.log('Ajout votant');
            // Ajouter votant
            voters[Date.now().toString()] = name + ' ‚Üí ' + choice.toUpperCase();
            return votersRef.set(voters);
          })
          .then(function() {
            console.log('‚úÖ Vote enregistr√© avec succ√®s');
            nameInput.value = '';
            alert('‚úÖ Vote enregistr√© pour ' + name + ' !');
          })
          .catch(function(error) {
            if (error !== 'Annul√©') {
              console.error('‚ùå Erreur:', error);
              alert('‚ùå Erreur: ' + error.message);
            }
          });
      }

      // Attacher les √©v√©nements
      document.getElementById('btnOui').onclick = function() {
        console.log('üñ±Ô∏è CLIC BOUTON OUI');
        faireVote('oui');
      };

      document.getElementById('btnNon').onclick = function() {
        console.log('üñ±Ô∏è CLIC BOUTON NON');
        faireVote('non');
      };

      // Touche Entr√©e
      document.getElementById('nameInput').onkeypress = function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
          console.log('‚å®Ô∏è ENTR√âE press√©e');
          faireVote('oui');
        }
      };

      console.log('‚úÖ TOUT EST PR√äT !');
    });
  </script>
</body>
</html>
